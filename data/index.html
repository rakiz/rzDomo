<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Piscine Monitoring</title>
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="stylesheet" href="siimple_3.3.1.min.css">
    <!-- link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/siimple@3.3.1/dist/siimple.min.css" -->
    <style>
        canvas {
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }
    </style>
</head>
<body>
    <div class="siimple-navbar siimple-navbar--extra-large siimple-navbar--dark">
        <a class="siimple-navbar-title" href="#">Piscine Monitoring</a>
    </div>
    <div class="siimple-jumbotron siimple-jumbotron--extra-large siimple-jumbotron--light">
<!-- -->
        <div class="siimple-jumbotron-detail">
            <a class="weatherwidget-io" href="https://forecast7.com/fr/45d704d88/venissieux/" data-label_1="VÉNISSIEUX" data-label_2="Météo" data-theme="original" >VÉNISSIEUX Météo</a>
            <script>
                !function(d,s,id){let js, fjs = d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src='https://weatherwidget.io/js/widget.min.js';fjs.parentNode.insertBefore(js,fjs);}}(document,'script','weatherwidget-io-js');
            </script>
        </div>
<!-- -->
    </div>
    <div class="siimple-content siimple-content--extra-large">
        <div class="siimple-grid">
            <div class="siimple-grid-row">
                <div class="siimple-h2">Température Piscine</div>
                <canvas id="tempChart" height="100"></canvas>

                <div class="siimple-grid-col siimple-grid-col--6">
                    <div class="siimple-list siimple-list--hover" style="max-width:400px;">
                    <div class="siimple-list-item">
                        <span id="pool-time" class="siimple-tag siimple-tag--primary siimple-tag--rounded">samedi 14 juillet 2020, 20:19:02</span>
                        Dernière mesure:
                    </div>
                    <div class="siimple-list-item">
                        <span id="pool-temp" class="siimple-tag siimple-tag--primary siimple-tag--rounded">14</span>
                        Température Piscine:
                    </div>
                    <div class="siimple-list-item">
                        <span class="siimple-tag siimple-tag--primary siimple-tag--rounded">7.2</span>
                        Potentiel Hydrogène:
                    </div>
                    <div class="siimple-list-item">
                        <span class="siimple-tag siimple-tag--primary siimple-tag--rounded">125</span>
                        Turbidité: 
                    </div>

                    <div class="siimple-btn siimple-btn--primary" onclick="updateData()">Force refresh</div>
                    <div class="siimple-btn siimple-btn--primary" onclick="resetZoom()">Reset Chart</div>
                </div>

                <div class="siimple-grid-col siimple-grid-col--6">
                </div>
            </div>
        </div>
        <div class="siimple-rule"></div>
    </div>
    <div class="siimple-footer siimple-footer--extra-large">
        <img src="https://badgen.net/badge/&copy;%20rakiz/2020.07/orange" alt="rakiz - 2020.07"/>
    </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/moment@2.27.0/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment-locale-fr@1.0.0/fr.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@0.7.7"></script>

<script>
    const dps = [];

    moment.locale('fr');
    const ctx = document.getElementById('tempChart');

    const config = {
        type: 'line',
        data: {
            datasets: [{
                label: 'Temperature piscine',
                fill: false,
                lineTension: 0.1,
                data: [],
            }]
        },
        options: {
            responsive: true,
            title: {
                display: false
            },
            tooltips: {
                position: 'nearest',
                mode: 'index',
                intersect: false,
            },
            scales: {
                xAxes: [{
                    type: 'time',
                    display: true,
                    //time: {
                    //    unit: 'hour',
                    //},
                    scaleLabel: {
                        display: true,
                        labelString: 'Date'
                    },
                    ticks: {
                        major: {
                            fontStyle: 'bold',
                            fontColor: '#FF0000'
                        }
                    }
                }],
                yAxes: [{
                    display: true,
                    scaleLabel: {
                        display: true,
                        labelString: '°C'
                    },
                    ticks: {
                        //suggestedMin: 10,
                        //suggestedMax: 30,

                        //min: 0,
                        //max: 50,

                        // forces step size to be 5 units
                        //stepSize: 1
                    }
                }]
            },
            plugins: {
                zoom: {
                    pan: {
                        enabled: true,
                        mode: 'x',
                        // On category scale, factor of pan velocity
                        speed: 20,
                        // Minimal pan distance required before actually applying pan
                        threshold: 10,
                    },
                    zoom: {
                        enabled: true,
                        drag: false,
                        mode: 'x',
                        speed: 0.05,
                    }
                }
            }
        }
    };
    const chart = new Chart(ctx, config);

    function debug(str) {
        if( console && console.debug ) {
            console.debug(str);
        }
    }

    function ts2str(timestamp) {
        return moment.unix(timestamp).format(); //"YYYY-mm-DDTHH:mm:ssZ")
    }

    let latestTimestamp = 0;
    function addData(mychart, chartindex, ts, value) {
        const c = mychart.data.datasets[chartindex].data;
        const str = ts2str(ts);
        if( c.length===0 || c[c.length-1].x !== str ) {
            debug("ADDED value: " + str + " - " + value);
            latestTimestamp = latestTimestamp<ts ? ts : latestTimestamp;
            c.push({x:str, y: value})
            mychart.update();
        } else {
            debug("IGNORED value: " + str + " - " + value);
        }
        if (c.length >  256 ) {
            c.shift();
        }
    }

    const updateInterval = 60 * 1000;
    updateData();
    setInterval(function(){updateData()}, updateInterval);

    function updateData() {
        if (window.fetch) {
            const myHeaders = new Headers();
            const myInit = {method: 'GET', headers: myHeaders, mode: 'cors', cache: 'default'};

            const url = '/api/metrics?since=' + latestTimestamp; // http://192.168.1.56
            debug(url);
            const myRequest = new Request(url, myInit);

            fetch(myRequest).then(function(response) {
                const contentType = response.headers.get("content-type");
                if(contentType && contentType.indexOf("application/json") !== -1) {
                    return response.json().then(function(json) {
                        if( json && Array.isArray(json) && json.length>0) { // if json is not an array, we have nothing to process
                            let time;
                            let temperature;
                            for(let i=0; i<json.length; i++) {
                                time = json[i].ts;
                                temperature = json[i].tp;
                                addData(chart, 0, time, temperature);
                                chart.update();
                            }
                            document.getElementById("pool-time").textContent = moment.unix(time).format('dddd Do MMMM YYYY, HH:mm:ss');
                            document.getElementById("pool-temp").textContent = temperature+"°C";
                        } else debug("Nothing retrieved"); //alert(json); // traitement du JSON
                    });
                } else {
                    debug("This is not the expected json: "+ contentType);
                }
            });
        } else {
            alert("Update your browser!");
        }
    }

    function resetZoom() {
        chart.resetZoom();
    }

</script>

</html>